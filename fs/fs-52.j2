service http enable
service https enable
!
logging server severity information
logging server address 10.40.40.5
!
ntp server {{sntp_server}}
!
hostname {{device|replace("#","")|replace(" ","-")}}
!
enable secret {{secret}}
!
banner login ^C
IP Flypack - {{device}}
^C
!
username admin privilege 4 secret {{secret}}
!
management ip address {{device.primary_ip4|ip()}} {{device.primary_ip4|netmask()}}
!
vlan database
vlan {{vlans|map(attribute='vid')|join(',')}}
{%- for vlan in vlans %}
    {%- if vlan.vid is defined %}
vlan {{vlan.vid}} name {{vlan.name}}
    {%- endif %}
{%- endfor %}
!
spanning-tree mode mstp
spanning-tree enable
!
spanning_tree mst configuration
 region {{mst_name}}
 revision {{mst_revision}}
!
{%- for interface in device.interfaces.all() %}
    {%- if interface.lag.label is defined %}
interface {{interface.label}}
 channel-group {{interface.lag.label|replace('agg','')}} mode active
        {%- set description = interface.description %}
        {%- if description == '' %}
            {%- if interface.link_peers %}
                {%- set peer = interface.link_peers|first %}
                {%- set description = peer.device %}
            {%- endif %}
        {%- endif %}
 description "{{description}}"
exit
    {%- else %}
        {%- if interface.enabled == True and interface.mgmt_only != True %}
interface {{interface.label}}
            {%- if interface.mode == 'tagged-all' %}
 switchport mode trunk           
 switchport trunk allowed vlan add all
            {%- elif interface.mode == 'tagged' %}
 switchport mode trunk           
 switchport trunk allowed vlan add {{interface.tagged_vlans.all()|join(',',attribute='vid')}}
                {%- if interface.untagged_vlan.vid is defined %}
 switchport trunk native vlan {{interface.untagged_vlan.vid}}
 switchport default-vlan tagged
                {%- endif %}
            {%- elif interface.mode == 'access' %}
 switchport mode access
 switchport access vlan {{interface.untagged_vlan.vid}}
                {%- if interface.is_lag %}
 mlag {{interface.label|replace('agg','')}}
                {%- endif %}
            {%- else %}
 no switchport mode
            {%- endif %}
            {%- set description = interface.description %}
            {%- if description == '' %}
                {%- if interface.link_peers %}
                    {%- set peer = interface.link_peers|first %}
                    {%- set description = peer.device %}
                {%- endif %}
            {%- endif %}
 description "{{description}}"
        {%- endif %}
    {%- endif %}
!   
{%- endfor %}
ip route 0.0.0.0/0 {{device.primary_ip4|gateway()}}
!
line con 0
 no line-password
 no login
line vty 0 7
 exec-timeout 35791 0
 privilege level 4
 no line-password
 no login
!
end